name: Train and Evaluate Models

on:
  push:
    tags:
      - "*-v[0-9]+"
  workflow_dispatch:
    inputs:
      flow-name:
        description: 'Nanoflow name'
        type: string
        required: true

jobs:
  train:
    runs-on: [self-hosted, linux, "3090"]
    timeout-minutes: 3600
    steps:
      - uses: actions/checkout@v4
      - name: Install the latest version of uv ðŸ“¦
        uses: astral-sh/setup-uv@v3
        with:
          cache-local-path: "~/.cache/uv"
      - name: Cache Venv
        id: cache-venv
        uses: MasterworksIO/action-local-cache@2
        with:
          path: .venv/
          key: ${{ runner.os }}-venv
      - name: Cache Log
        id: cache-log
        uses: MasterworksIO/action-local-cache@2
        with:
          path: logs/
          key: ${{ runner.os }}-logs
      - name: Install dependencies ðŸ“¦
        env:
          UV_HTTP_TIMEOUT: 1000
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: uv sync --all-extras --index-url https://pypi.tuna.tsinghua.edu.cn/simple
      - name: Download dataset and checkpoints
        run: |
          mkdir -p ./datasets
          rm -rf ./datasets/MELD
          ln -s ~/datasets/MELD.AudioOnly ./datasets/MELD
          ln -s ~/checkpoints ./checkpoints
      - name: Run nanoflow
        if: github.event_name != 'workflow_dispatch'
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          FLOW_NAME=${TAG_NAME%-v*}
          uvx nanoflow experiments/$FLOW_NAME.toml
      - name: Run nanoflow
        if: github.event_name == 'workflow_dispatch'
        run: uvx nanoflow experiments/${{ inputs.flow-name }}.toml
