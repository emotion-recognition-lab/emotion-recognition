name: Train and Evaluate Models

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  train:
    runs-on: [self-hosted, linux]
    timeout-minutes: 3600
    steps:
      - uses: actions/checkout@v4
      - name: Install the latest version of uv ðŸ“¦
        uses: astral-sh/setup-uv@v2
      - name: Cache Venv
        id: cache-venv
        uses: MasterworksIO/action-local-cache@2
        with:
          path: .venv/
          key: ${{ runner.os }}-uv
      - name: Cache Checkpoints
        id: cache-checkpoints
        uses: MasterworksIO/action-local-cache@2
        with:
          path: checkpoints/
          key: ${{ runner.os }}-checkpoints
      - name: Install dependencies ðŸ“¦
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: uv sync --all-extras --dev
      - name: Download dataset
        run: |
          mkdir -p ./datasets
          rm -rf ./datasets/MELD
          ln -s ~/datasets/MELD.AudioOnly ./datasets/MELD
      - name: Run nanoflow
        run: uv tool run nanoflow experiments/mix-finetuning.toml
